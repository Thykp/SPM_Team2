# ---------- BUILD STAGE ----------
FROM maven:3.9.6-eclipse-temurin-21 AS build
WORKDIR /app

# Copy everything in the context
COPY . /app

# Verify files are copied (debug)
RUN echo "Listing /app after COPY:" && ls -lR /app

# Build the fat jar (skip tests for faster build)
RUN mvn -B -DskipTests clean package

# ---------- RUN STAGE ----------
FROM eclipse-temurin:21-jre-jammy
WORKDIR /app

# Create a non-root user
RUN useradd -r -s /usr/sbin/nologin appuser
USER appuser

# Set Spring profile for Docker
ENV SPRING_PROFILES_ACTIVE=docker
ENV JAVA_OPTS=""

# Expose application port
EXPOSE 8091

# Copy the jar built by Maven
COPY --from=build /app/target/manage_task-0.0.1-SNAPSHOT.jar /app/app.jar

# Optional TCP healthcheck
HEALTHCHECK --interval=30s --timeout=3s --start-period=20s --retries=3 \
  CMD bash -c '</dev/tcp/127.0.0.1/8091' || exit 1

# Run the application
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar /app/app.jar"]
