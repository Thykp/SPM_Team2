# syntax=docker/dockerfile:1
FROM node:20-slim

# Set env + working directory
ENV NODE_ENV=production
WORKDIR /app

# Install build dependencies for canvas package
RUN apt-get update && apt-get install -y \
    libcairo2-dev libpango1.0-dev libjpeg-dev libgif-dev librsvg2-dev \
    fonts-dejavu fonts-noto-core && \
    rm -rf /var/lib/apt/lists/*

# RUN apk add --no-cache python3 make g++ pkgconfig pixman-dev cairo-dev pango-dev jpeg-dev giflib-dev 



# Install only production deps
COPY package*.json ./
RUN npm ci --omit=dev


# Copy the rest of the source
COPY . .

# Run as non-root for safety
USER node

# Expose the app port (your app defaults to 3040 if PORT isn't provided)
ENV PORT=3042
EXPOSE 3042

# Start the server
CMD ["node", "index.js"]
